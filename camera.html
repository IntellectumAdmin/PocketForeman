<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–ö–∞–º–µ—Ä–∞ Pocket Foreman</title>
  <style>
    :root { color-scheme: light dark; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background:#f6f7f9; }
    .wrap { max-width: 720px; margin: 48px auto; padding: 16px; }
    h1 { text-align:center; margin: 0 0 16px; }
    .card { background:#fff; border-radius:16px; padding:16px; box-shadow: 0 6px 20px rgba(0,0,0,.08); }
    video, canvas, img { width:100%; border-radius:12px; background:#000; }
    .row { display:flex; gap:10px; margin-top:14px; }
    button { flex:1; padding:12px; border:0; border-radius:10px; font-size:16px; cursor:pointer; }
    .primary { background:#1976d2; color:#fff; }
    .ghost   { background:#eef3f7; }
    #status { margin-top:10px; font-size:14px; color:#333; min-height:1.2em; }
    .hint { margin-top:6px; font-size:13px; opacity:.7; text-align:center; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>üì∑ –ö–∞–º–µ—Ä–∞ Pocket Foreman</h1>
    <div class="card">
      <video id="vid" autoplay playsinline></video>
      <canvas id="cnv" style="display:none;"></canvas>

      <div class="row">
        <button id="btnFlip" class="ghost">üîÅ –ü–æ–≤–µ—Ä–Ω—É—Ç—å –∫–∞–º–µ—Ä—É</button>
        <button id="btnShot" class="primary">üì∏ –°–¥–µ–ª–∞—Ç—å —Ñ–æ—Ç–æ</button>
      </div>

      <img id="preview" alt="preview" style="display:none; margin-top:12px;" />

      <div class="row" id="sendRow" style="display:none;">
        <button id="btnSend" class="primary">üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
      </div>

      <div id="status"></div>
      <div class="hint" id="where"></div>
    </div>
  </div>

  <script>
  (function () {
    // ===== –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑ URL =====
    const qs = new URLSearchParams(location.search);
    const CLOUD   = qs.get('cloud')   || '';     // cloud name
    const PRESET  = qs.get('preset')  || '';     // unsigned upload preset
    const FOLDER  = qs.get('folder')  || '';     // –∫—É–¥–∞ –∫–ª–∞—Å—Ç—å –≤ Cloudinary
    const SECTION = qs.get('section') || '';     // –∫—Ä–∞—Å–∏–≤–æ–µ –∏–º—è —Ä–∞–∑–¥–µ–ª–∞ –¥–ª—è Notion
    const CAM     = (qs.get('cam') || 'back').toLowerCase();

    const tg = window.Telegram?.WebApp;
    if (tg) tg.expand(); // —á—É—Ç—å —Ä–∞—Å—à–∏—Ä–∏–º web-app –≤ —Ç–µ–ª–µ–≥—Ä–∞–º–µ

    // ===== UI =====
    const vid = document.getElementById('vid');
    const cnv = document.getElementById('cnv');
    const preview = document.getElementById('preview');
    const btnFlip = document.getElementById('btnFlip');
    const btnShot = document.getElementById('btnShot');
    const btnSend = document.getElementById('btnSend');
    const sendRow = document.getElementById('sendRow');
    const statusEl = document.getElementById('status');
    const whereEl  = document.getElementById('where');

    whereEl.textContent = SECTION ? `–†–∞–∑–¥–µ–ª: ${SECTION}` : '';

    let useBack = CAM === 'back';
    let stream = null;
    let lastDataUrl = null;

    const setStatus = (t) => statusEl.textContent = t || '';

    async function startCamera() {
      if (!navigator.mediaDevices?.getUserMedia) {
        setStatus('–ë—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∫–∞–º–µ—Ä—É');
        return;
      }
      // –û—Å—Ç–∞–Ω–æ–≤–∏–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Å—Ç—Ä–∏–º
      if (stream) { stream.getTracks().forEach(t => t.stop()); stream = null; }

      setStatus('–ó–∞–ø—É—Å–∫ –∫–∞–º–µ—Ä—ã‚Ä¶');
      const primaryFacing = useBack ? { exact: 'environment' } : 'user';
      try {
        stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: primaryFacing }, audio: false
        });
      } catch (e) {
        // –§–æ–ª–±—ç–∫ –±–µ–∑ exact
        stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: useBack ? 'environment' : 'user' }, audio: false
        });
      }
      vid.srcObject = stream;
      await vid.play().catch(()=>{});
      setStatus(useBack ? '–ó–∞–¥–Ω—è—è –∫–∞–º–µ—Ä–∞' : '–§—Ä–æ–Ω—Ç–∞–ª—å–Ω–∞—è –∫–∞–º–µ—Ä–∞');
    }

    btnFlip.addEventListener('click', async () => {
      useBack = !useBack;
      await startCamera();
    });

    btnShot.addEventListener('click', () => {
      const w = vid.videoWidth, h = vid.videoHeight;
      if (!w || !h) return;
      cnv.width = w; cnv.height = h;
      cnv.getContext('2d').drawImage(vid, 0, 0, w, h);
      lastDataUrl = cnv.toDataURL('image/jpeg', 0.92);
      preview.src = lastDataUrl;
      preview.style.display = 'block';
      sendRow.style.display = 'flex';
      setStatus('–°–Ω–∏–º–æ–∫ –≥–æ—Ç–æ–≤');
    });

    // ===== –ó–∞–≥—Ä—É–∑–∫–∞ –≤ Cloudinary (unsigned) =====
    async function uploadToCloudinary(dataUrl) {
      // dataUrl -> Blob
      const resp = await fetch(dataUrl);
      const blob = await resp.blob();

      const form = new FormData();
      form.append('file', blob, 'pocket_foreman.jpg');
      form.append('upload_preset', PRESET);
      if (FOLDER) form.append('folder', FOLDER);

      const url = `https://api.cloudinary.com/v1_1/${encodeURIComponent(CLOUD)}/image/upload`;

      const r = await fetch(url, { method: 'POST', body: form });
      if (!r.ok) {
        const txt = await r.text();
        throw new Error(`Cloudinary: ${r.status} ${txt}`);
      }
      return r.json(); // { secure_url, public_id, ... }
    }

    btnSend.addEventListener('click', async () => {
      if (!CLOUD || !PRESET) {
        setStatus('–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∑–∞–≥—Ä—É–∑–∫–∏ (cloud/preset).');
        return;
      }
      if (!lastDataUrl) {
        setStatus('–°–¥–µ–ª–∞–π—Ç–µ —Ñ–æ—Ç–æ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π.');
        return;
      }

      btnSend.disabled = true;
      setStatus('–ó–∞–≥—Ä—É–∑–∫–∞ –≤ –æ–±–ª–∞–∫–æ‚Ä¶');

      try {
        const data = await uploadToCloudinary(lastDataUrl);
        const secureUrl = data.secure_url;

        setStatus('–ì–æ—Ç–æ–≤–æ. –°—Å—ã–ª–∫–∞ –ø–æ–ª—É—á–µ–Ω–∞.');
        // –û—Ç–ø—Ä–∞–≤–∏–º –æ–±—Ä–∞—Ç–Ω–æ –≤ Telegram –±–æ—Ç–∞
        if (tg && secureUrl) {
          tg.sendData(JSON.stringify({
            type: 'photo_uploaded',
            url: secureUrl,
            section: SECTION || ''
          }));
        } else {
          alert('–°—Å—ã–ª–∫–∞: ' + secureUrl);
        }
      } catch (e) {
        console.error(e);
        setStatus('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + e.message);
        btnSend.disabled = false;
      }
    });

    startCamera();
  })();
  </script>
</body>
</html>
